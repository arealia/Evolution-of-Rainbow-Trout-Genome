# CAFE tutorial commands (please run them all from the tutorial folder)

# Downloading the data

tar -zxvf twelve_spp_proteins.tar.gz
for i in `ls -1 twelve_spp_proteins/*.tar.gz`; do tar -zxvf $i -C twelve_spp_proteins/; done

# Moving all longest isoforms into a single file

python python_scripts/cafetutorial_longest_iso.py -d twelve_spp_proteins/
cat twelve_spp_proteins/longest*.fa > makeblastdb_input.fa

# Making BLAST database

makeblastdb -in makeblastdb_input.fa -dbtype prot -out blastdb

# All-by-all blastp

 blastp -num_threads 4 -db blast.db -query makeblastdb_input.fa -outfmt 7 -seg yes > blast_output.tx

# Clustering sequences with mcl

grep -v "#" blast_output.txt | cut -f 1,2,11 > blast_output.abc

mcxload -abc blast_output.abc --stream-mirror --stream-neg-log10 -stream-tf 'ceil(200)' -o blast_output.mci -write-tab blast_output.tab

mcl blast_output.mci -I 3

mcxdump -icl out.blast_output.mci.I30 -tabr blast_output.tab -o dump.blast_output.mci.I30

# Final parsing of mcl's output

python python_scripts/cafetutorial_mcl2rawcafe.py -i dump.blast_output.mci.I30 -o unfiltered_cafe_input.txt -sp "ENSG00 ENSPTR ENSPPY ENSPAN ENSNLE ENSMMU ENSCJA ENSRNO ENSMUS ENSFCA ENSECA ENSBTA"

python python_scripts/cafetutorial_clade_and_size_filter.py -i unfiltered_cafe_input.txt -o filtered_cafe_input.txt -s

mv filtered_cafe_input_names.txt filtered_cafe_input.txt

mv large_filtered_cafe_input_names.txt large_filtered_cafe_input.txt
